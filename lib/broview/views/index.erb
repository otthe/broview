<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Broview - Media Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    img, audio, video {
      max-width: 90%;
      margin: 20px auto;
      display: block;
    }
    .media-container {
      margin: 20px;
      padding: 20px;
      border: 1px solid #ccc;
      background: #fff;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <h1>Broview - Media Viewer</h1>

  <script>
    const baseSoundLevel = <%= @base_sound_level.to_json %>;
    const mediaFiles = <%= @media_files.to_json %>;

    console.log(baseSoundLevel);
    console.log(mediaFiles);
    
    document.addEventListener("DOMContentLoaded", () => {
      mediaFiles.forEach(file => {
        const element = document.querySelector(`[data-file="${file.name}"]`);
        if (!element) return;

        const volumeAdjustment = Math.pow(10, (baseSoundLevel - file.sound_level) / 20);

        const audioElement = element.querySelector("audio");
        if (audioElement) {
          audioElement.volume = Math.min(1, Math.max(0, volumeAdjustment));
        }

        const videoElement = element.querySelector("video");
        if (videoElement) {
          videoElement.volume = Math.min(1, Math.max(0, volumeAdjustment));
        }
      });
    });
  </script>

  <% @media_files.each do |file| %>
    <div class="media-container" data-file="<%= file[:name] %>">
      <h3><%= file[:name] %></h3>
      <% if @image_extensions.include?(file[:type]) %>
        <img src="<%= file[:path] %>" alt="<%= file[:name] %>">
      <% elsif @audio_extensions.include?(file[:type]) %>
        <audio controls>
          <source src="<%= file[:path] %>" type="audio/<%= file[:type][1..-1] %>">
          Your browser does not support the audio element.
        </audio>
      <% elsif @video_extensions.include?(file[:type]) %>
        <video controls>
          <source src="<%= file[:path] %>" type="video/<%= file[:type][1..-1] %>">
          Your browser does not support the video element.
        </video>
      <% end %>
    </div>
  <% end %>
</body>
</html>